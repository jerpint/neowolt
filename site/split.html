<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>nw</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.min.css">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100dvh; overflow: hidden; background: #0d1117; }
    body { display: flex; flex-direction: column; }

    #topbar {
      background: #161b22;
      border-bottom: 1px solid #21262d;
      padding: 0.4rem 0.75rem;
      display: flex; align-items: center; justify-content: space-between;
      font-family: 'SF Mono','Fira Code',monospace;
      font-size: 0.8rem; flex-shrink: 0;
    }
    #topbar .left { display: flex; align-items: center; gap: 0.4rem; }
    #topbar .title { color: #6b9; font-weight: 600; }
    #topbar .status { color: #555; font-size: 0.65rem; }
    #topbar .actions { display: flex; gap: 0.4rem; }
    #topbar .actions button {
      font-family: inherit; font-size: 0.72rem;
      padding: 0.25rem 0.6rem; background: #21262d;
      border: 1px solid #30363d; border-radius: 4px;
      color: #666; cursor: pointer;
    }
    #topbar .actions button:hover { border-color: #6b9; color: #c9d1d9; }
    #topbar .actions button:disabled { opacity: 0.3; cursor: default; border-color: #30363d; color: #444; }
    #topbar .actions button.active { border-color: #6b9; color: #6b9; }

    /* history panel */
    #right { position: relative; }
    #hist-panel {
      position: absolute; top: 0; right: 0; bottom: 0; width: 220px;
      background: #161b22; border-left: 1px solid #21262d;
      display: flex; flex-direction: column;
      z-index: 50; transform: translateX(100%);
      transition: transform 0.2s ease;
      font-family: 'SF Mono','Fira Code',monospace;
    }
    #hist-panel.open { transform: translateX(0); }
    #hist-header {
      padding: 0.4rem 0.75rem; border-bottom: 1px solid #21262d;
      display: flex; justify-content: space-between; align-items: center;
      font-size: 0.7rem; color: #555; flex-shrink: 0;
    }
    #hist-header button {
      background: none; border: none; color: #555; cursor: pointer;
      font-size: 0.9rem; padding: 0; line-height: 1;
    }
    #hist-header button:hover { color: #c9d1d9; }
    #hist-list { flex: 1; overflow-y: auto; padding: 0.25rem 0; }
    #hist-list::-webkit-scrollbar { width: 4px; }
    #hist-list::-webkit-scrollbar-thumb { background: #30363d; border-radius: 2px; }
    .hist-item {
      padding: 0.45rem 0.75rem; cursor: pointer;
      border-bottom: 1px solid #21262d11;
      transition: background 0.1s;
    }
    .hist-item:hover { background: #21262d; }
    .hist-item.current { background: #1a3a2a; }
    .hist-title { display: block; font-size: 0.72rem; color: #c9d1d9; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .hist-time  { display: block; font-size: 0.62rem; color: #484f58; margin-top: 1px; }

    #split {
      flex: 1; display: flex; overflow: hidden;
    }

    #left {
      width: 50%;
      display: flex; flex-direction: column; overflow: hidden;
      transition: width 0.2s ease;
    }

    #right {
      width: 50%; display: flex; flex-direction: column; overflow: hidden;
      transition: width 0.2s ease;
    }

    #drag-handle {
      width: 4px; flex-shrink: 0;
      background: #21262d; cursor: col-resize;
      position: relative; touch-action: none; z-index: 10;
      transition: background 0.15s;
    }
    #drag-handle:hover, #drag-handle.dragging { background: #3a7a5a; }
    #drag-handle::before { content: ''; position: absolute; inset: 0 -6px; }

    #split.left-full  #left  { width: 100%; }
    #split.left-full  #right { width: 0; overflow: hidden; }
    #split.right-full #left  { width: 0; overflow: hidden; }
    #split.right-full #right { width: 100%; }

    #terminal { flex: 1; overflow: hidden; }
    .xterm { height: 100%; }

    @media (max-width: 768px) {
      #drag-handle { display: none; }
      #split #left  { width: 100%; }
      #split #right { width: 0; overflow: hidden; }
      #split.right-full #left  { width: 0 !important; overflow: hidden; }
      #split.right-full #right { width: 100% !important; }
    }

    #preview { flex: 1; border: none; background: #0d1117; display: block; }
  </style>
</head>
<body>
  <div id="topbar">
    <div class="left">
      <span class="title">nw</span>
      <span class="status" id="tui-status">connecting...</span>
    </div>
    <div class="actions">
      <button id="btn-back"    onclick="goBack()"            title="Back" disabled>◁</button>
      <button id="btn-hist"    onclick="toggleHist()"        title="View history">≡</button>
      <button id="btn-term"    onclick="toggleFull('left')"  title="Fullscreen terminal">⬛ term</button>
      <button id="btn-preview" onclick="toggleFull('right')" title="Session view">⬛ session</button>
    </div>
  </div>

  <div id="split">
    <div id="left">
      <div id="terminal"></div>
    </div>
    <div id="drag-handle"></div>
    <div id="right">
      <iframe id="preview" src="/index.html"></iframe>
      <div id="hist-panel">
        <div id="hist-header">
          <span>views</span>
          <button onclick="toggleHist()">✕</button>
        </div>
        <div id="hist-list"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { Terminal }     from 'https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/+esm';
    import { FitAddon }     from 'https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/+esm';
    import { WebLinksAddon } from 'https://cdn.jsdelivr.net/npm/@xterm/addon-web-links@0.11.0/+esm';

    // ── Terminal ──────────────────────────────────────────────────────────────
    const statusEl = document.getElementById('tui-status');
    const term = new Terminal({
      cursorBlink: true, fontSize: 13,
      fontFamily: "'SF Mono','Fira Code','Consolas',monospace",
      theme: {
        background: '#0d1117', foreground: '#c9d1d9', cursor: '#6b9',
        selectionBackground: '#264f78',
        black: '#0d1117', red: '#f66',    green: '#6b9',
        yellow: '#e5c07b', blue: '#61afef', magenta: '#c678dd',
        cyan: '#56b6c2',  white: '#c9d1d9',
      },
    });

    const fitAddon = new FitAddon();
    term.loadAddon(fitAddon);
    term.loadAddon(new WebLinksAddon());
    term.open(document.getElementById('terminal'));
    fitAddon.fit();

    let ws = null;
    function connectTUI() {
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(proto + '//' + location.host + '/tui');
      ws.onopen = () => {
        statusEl.textContent = 'connected';
        statusEl.style.color = '#6b9';
        ws.send(JSON.stringify({ type: 'resize', cols: term.cols, rows: term.rows }));
      };
      ws.onmessage = (e) => term.write(e.data);
      ws.onclose = () => {
        statusEl.textContent = 'reconnecting...';
        statusEl.style.color = '#f66';
        setTimeout(connectTUI, 2000);
      };
      ws.onerror = () => ws.close();
    }

    term.onData(d => ws?.readyState === WebSocket.OPEN && ws.send(d));
    term.onResize(({ cols, rows }) => {
      if (ws?.readyState === WebSocket.OPEN)
        ws.send(JSON.stringify({ type: 'resize', cols, rows }));
    });

    window.addEventListener('resize', () => fitAddon.fit());
    new ResizeObserver(() => fitAddon.fit()).observe(document.getElementById('terminal'));
    // ensure fit after mobile CSS applies on first paint
    setTimeout(() => fitAddon.fit(), 100);

    // touch scroll → send mouse wheel escape sequences to tmux
    if ('ontouchstart' in window) {
      let lastTouchY = 0;
      const termEl = document.getElementById('terminal');
      termEl.addEventListener('touchstart', e => {
        lastTouchY = e.touches[0].clientY;
      }, { passive: true });
      termEl.addEventListener('touchmove', e => {
        const dy = lastTouchY - e.touches[0].clientY;
        lastTouchY = e.touches[0].clientY;
        const lines = Math.round(Math.abs(dy) / 25);
        if (lines === 0 || ws?.readyState !== WebSocket.OPEN) return;
        // SGR mouse: button 64 = wheel up, 65 = wheel down
        const seq = dy > 0 ? '\x1b[<65;1;1M' : '\x1b[<64;1;1M';
        for (let i = 0; i < lines; i++) ws.send(seq);
      }, { passive: true });
    }
    connectTUI();

    // ── Right pane: views + history ───────────────────────────────────────────
    const preview  = document.getElementById('preview');
    const btnBack  = document.getElementById('btn-back');
    const btnHist  = document.getElementById('btn-hist');
    const histPanel = document.getElementById('hist-panel');
    const histList  = document.getElementById('hist-list');

    let lastUrl   = null;
    let viewStack = [];   // [{url, title, t}]
    let stackIdx  = -1;
    let histOpen  = false;

    function timeAgo(ts) {
      const s = Math.floor((Date.now() - ts) / 1000);
      if (s < 60)    return 'just now';
      if (s < 3600)  return Math.floor(s / 60) + 'm ago';
      if (s < 86400) return Math.floor(s / 3600) + 'h ago';
      return Math.floor(s / 86400) + 'd ago';
    }

    function renderHist() {
      histList.innerHTML = viewStack.slice().reverse().map((e, ri) => {
        const i = viewStack.length - 1 - ri;
        return `<div class="hist-item${i === stackIdx ? ' current' : ''}" onclick="jumpTo(${i})">
          <span class="hist-title">${e.title}</span>
          <span class="hist-time">${timeAgo(e.t)}</span>
        </div>`;
      }).join('');
    }

    function updateBackBtn() {
      btnBack.disabled = stackIdx <= 0;
    }

    function loadView(url, title, pushToStack = true) {
      preview.src = url;
      lastUrl = url;
      if (pushToStack) {
        viewStack.splice(stackIdx + 1);
        viewStack.push({ url, title, t: Date.now() });
        stackIdx = viewStack.length - 1;
      }
      updateBackBtn();
      renderHist();
    }

    window.goBack = () => {
      if (stackIdx > 0) {
        stackIdx--;
        const e = viewStack[stackIdx];
        lastUrl = e.url;
        preview.src = e.url;
        updateBackBtn();
        renderHist();
      }
    };

    window.jumpTo = (i) => {
      if (i >= 0 && i < viewStack.length) {
        stackIdx = i;
        const e = viewStack[i];
        lastUrl = e.url;
        preview.src = e.url;
        updateBackBtn();
        renderHist();
      }
    };

    window.toggleHist = () => {
      histOpen = !histOpen;
      histPanel.classList.toggle('open', histOpen);
      btnHist.classList.toggle('active', histOpen);
      if (histOpen) renderHist();
    };

    // seed from server history on load
    fetch('/views/history').then(r => r.json()).then(entries => {
      viewStack = entries.slice().reverse(); // server returns newest-first, we want oldest-first
      stackIdx  = viewStack.length - 1;
      updateBackBtn();
    }).catch(() => {});

    async function pollCurrent() {
      try {
        const { url } = await fetch('/current/meta').then(r => r.json());
        if (url && url !== lastUrl) {
          // derive title from path (server has richer title but we don't need it here)
          const title = url.split('/').pop().replace('.html','').replace(/-/g,' ') || url;
          loadView(url, title);
        }
      } catch {}
    }
    pollCurrent();
    setInterval(pollCurrent, 2000);

    // ── Drag to resize ────────────────────────────────────────────────────────
    const leftPane   = document.getElementById('left');
    const rightPane  = document.getElementById('right');
    const dragHandle = document.getElementById('drag-handle');
    let dragging = false;

    dragHandle.addEventListener('pointerdown', e => {
      if (split.classList.contains('left-full') || split.classList.contains('right-full')) return;
      dragging = true;
      dragHandle.setPointerCapture(e.pointerId);
      dragHandle.classList.add('dragging');
      leftPane.style.transition  = 'none';
      rightPane.style.transition = 'none';
      e.preventDefault();
    });

    dragHandle.addEventListener('pointermove', e => {
      if (!dragging) return;
      const rect  = split.getBoundingClientRect();
      const ratio = Math.max(0.15, Math.min(0.85, (e.clientX - rect.left) / rect.width));
      leftPane.style.width  = (ratio * 100).toFixed(1) + '%';
      rightPane.style.width = ((1 - ratio) * 100).toFixed(1) + '%';
      fitAddon.fit();
    });

    dragHandle.addEventListener('pointerup', () => {
      if (!dragging) return;
      dragging = false;
      dragHandle.classList.remove('dragging');
      leftPane.style.transition  = '';
      rightPane.style.transition = '';
      fitAddon.fit();
    });

    // ── Fullscreen toggle ─────────────────────────────────────────────────────
    const split      = document.getElementById('split');
    const btnTerm    = document.getElementById('btn-term');
    const btnPreview = document.getElementById('btn-preview');

    window.toggleFull = (side) => {
      leftPane.style.width  = '';
      rightPane.style.width = '';
      const cls   = side === 'left' ? 'left-full' : 'right-full';
      const other = side === 'left' ? 'right-full' : 'left-full';
      if (window.innerWidth <= 768) {
        // mobile: CSS default is terminal-full, right-full class shows preview
        if (side === 'right') split.classList.add('right-full');
        else split.classList.remove('right-full');
      } else {
        if (split.classList.contains(cls)) {
          split.classList.remove(cls);
          btnTerm.textContent    = '⬛ term';
          btnPreview.textContent = '⬛ session';
        } else {
          split.classList.remove(other);
          split.classList.add(cls);
          btnTerm.textContent    = side === 'left'  ? '◧ split' : '⬛ term';
          btnPreview.textContent = side === 'right' ? '◨ split' : '⬛ session';
        }
      }
      setTimeout(() => fitAddon.fit(), 250);
    };
  </script>
</body>
</html>
