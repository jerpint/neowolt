<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>nw · split</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.min.css">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100dvh; overflow: hidden; background: #0d1117; }
    body { display: flex; flex-direction: column; }

    #topbar {
      background: #161b22;
      border-bottom: 1px solid #21262d;
      padding: 0.4rem 0.75rem;
      display: flex; align-items: center; justify-content: space-between;
      font-family: 'SF Mono','Fira Code',monospace;
      font-size: 0.8rem; flex-shrink: 0;
    }
    #topbar .title { color: #6b9; font-weight: 600; }
    #topbar .status { color: #555; font-size: 0.7rem; margin-left: 0.5rem; }
    #topbar .actions { display: flex; gap: 0.5rem; }
    #topbar .actions a {
      font-family: inherit; font-size: 0.75rem;
      padding: 0.3rem 0.7rem; background: #21262d;
      border: 1px solid #30363d; border-radius: 4px;
      color: #888; cursor: pointer; text-decoration: none;
    }
    #topbar .actions a:hover { border-color: #6b9; color: #c9d1d9; }
    #topbar .actions button {
      font-family: inherit; font-size: 0.75rem;
      padding: 0.3rem 0.7rem; background: #21262d;
      border: 1px solid #30363d; border-radius: 4px;
      color: #888; cursor: pointer;
    }
    #topbar .actions button:hover { border-color: #6b9; color: #c9d1d9; }

    #split {
      flex: 1; display: flex; overflow: hidden;
    }

    #left {
      width: 50%; border-right: 1px solid #21262d;
      display: flex; flex-direction: column; overflow: hidden;
      transition: width 0.2s ease;
    }

    #right {
      width: 50%; display: flex; flex-direction: column; overflow: hidden;
      background: #0d1117;
      transition: width 0.2s ease;
    }

    #split.left-full #left  { width: 100%; }
    #split.left-full #right { width: 0; overflow: hidden; border: none; }
    #split.right-full #left  { width: 0; overflow: hidden; border: none; }
    #split.right-full #right { width: 100%; }

#terminal { flex: 1; overflow: hidden; }
    .xterm { height: 100%; }

    #preview {
      flex: 1; border: none; background: #0d1117;
    }

    #right-bar {
      background: #161b22; border-top: 1px solid #21262d;
      padding: 0.3rem 0.75rem;
      font-family: 'SF Mono','Fira Code',monospace;
      font-size: 0.7rem; color: #444;
      display: flex; justify-content: space-between; align-items: center;
    }
    #current-url { color: #555; }
    #reload-btn {
      font-family: inherit; font-size: 0.7rem;
      background: none; border: 1px solid #30363d;
      border-radius: 3px; color: #555; cursor: pointer; padding: 0.1rem 0.4rem;
    }
    #reload-btn:hover { border-color: #6b9; color: #6b9; }
  </style>
</head>
<body>
  <div id="topbar">
    <div>
      <span class="title">nw split</span>
      <span class="status" id="tui-status">connecting...</span>
    </div>
    <div class="actions">
      <button id="expand-left-btn" onclick="toggleFull('left')" title="Fullscreen terminal">⬛ term</button>
      <button id="expand-right-btn" onclick="toggleFull('right')" title="Fullscreen preview">⬛ preview</button>
      <a href="/tui">tui</a>
      <a href="/work.html">work</a>
    </div>
  </div>

  <div id="split">
    <div id="left">
      <div id="terminal"></div>
    </div>
    <div id="right">
      <iframe id="preview" src="/"></iframe>
      <div id="right-bar">
        <span id="current-url">/</span>
        <button id="reload-btn" onclick="reloadPreview()">reload</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { Terminal } from 'https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/+esm';
    import { FitAddon } from 'https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/+esm';
    import { WebLinksAddon } from 'https://cdn.jsdelivr.net/npm/@xterm/addon-web-links@0.11.0/+esm';

    // --- Terminal ---
    const statusEl = document.getElementById('tui-status');
    const term = new Terminal({
      cursorBlink: true, fontSize: 13,
      fontFamily: "'SF Mono','Fira Code','Consolas',monospace",
      theme: {
        background: '#0d1117', foreground: '#c9d1d9', cursor: '#6b9',
        selectionBackground: '#264f78',
        black: '#0d1117', red: '#f66', green: '#6b9',
        yellow: '#e5c07b', blue: '#61afef', magenta: '#c678dd',
        cyan: '#56b6c2', white: '#c9d1d9',
      },
    });

    const fitAddon = new FitAddon();
    term.loadAddon(fitAddon);
    term.loadAddon(new WebLinksAddon());
    term.open(document.getElementById('terminal'));
    fitAddon.fit();

    let ws = null;
    function connectTUI() {
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(proto + '//' + location.host + '/tui');
      ws.onopen = () => {
        statusEl.textContent = 'connected';
        statusEl.style.color = '#6b9';
        ws.send(JSON.stringify({ type: 'resize', cols: term.cols, rows: term.rows }));
      };
      ws.onmessage = (e) => term.write(e.data);
      ws.onclose = () => {
        statusEl.textContent = 'reconnecting...';
        statusEl.style.color = '#f66';
        setTimeout(connectTUI, 2000);
      };
      ws.onerror = () => ws.close();
    }

    term.onData(d => ws?.readyState === WebSocket.OPEN && ws.send(d));
    term.onResize(({ cols, rows }) => {
      if (ws?.readyState === WebSocket.OPEN)
        ws.send(JSON.stringify({ type: 'resize', cols, rows }));
    });

    window.addEventListener('resize', () => fitAddon.fit());
    new ResizeObserver(() => fitAddon.fit()).observe(document.getElementById('terminal'));
    connectTUI();

    // --- Right pane: poll /current/meta for changes ---
    const preview = document.getElementById('preview');
    const urlLabel = document.getElementById('current-url');
    let lastUrl = null;

    async function pollCurrent() {
      try {
        const { url } = await fetch('/current/meta').then(r => r.json());
        if (url !== lastUrl) {
          lastUrl = url;
          preview.src = url;
          urlLabel.textContent = url;
        }
      } catch {}
    }

    // Initial load
    pollCurrent();
    setInterval(pollCurrent, 2000);

    window.reloadPreview = () => { preview.src = preview.src; };

    // --- Fullscreen toggle ---
    const split = document.getElementById('split');
    const expandLeftBtn = document.getElementById('expand-left-btn');
    const expandRightBtn = document.getElementById('expand-right-btn');

    window.toggleFull = (side) => {
      const cls = side === 'left' ? 'left-full' : 'right-full';
      const other = side === 'left' ? 'right-full' : 'left-full';
      if (split.classList.contains(cls)) {
        split.classList.remove(cls);
        expandLeftBtn.textContent = '⬛ term';
        expandRightBtn.textContent = '⬛ preview';
      } else {
        split.classList.remove(other);
        split.classList.add(cls);
        if (side === 'left') {
          expandLeftBtn.textContent = '◧ split';
          expandRightBtn.textContent = '⬛ preview';
        } else {
          expandRightBtn.textContent = '◨ split';
          expandLeftBtn.textContent = '⬛ term';
        }
      }
      setTimeout(() => fitAddon.fit(), 250);
    };
  </script>
</body>
</html>
