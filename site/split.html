<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>nw</title>
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.min.css">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100dvh; overflow: hidden; background: #0d1117; }
    body { display: flex; flex-direction: column; }

    #topbar {
      background: #161b22;
      border-bottom: 1px solid #21262d;
      padding: 0.4rem 0.75rem;
      display: flex; align-items: center; justify-content: space-between;
      font-family: 'SF Mono','Fira Code',monospace;
      font-size: 0.8rem; flex-shrink: 0;
    }
    #topbar .left { display: flex; align-items: center; gap: 0.4rem; }
    #topbar .title { color: #6b9; font-weight: 600; }
    #topbar .status { color: #555; font-size: 0.65rem; }
    #topbar .actions { display: flex; gap: 0.4rem; }
    #topbar .actions button {
      font-family: inherit; font-size: 0.72rem;
      padding: 0.25rem 0.6rem; background: #21262d;
      border: 1px solid #30363d; border-radius: 4px;
      color: #666; cursor: pointer;
    }
    #topbar .actions button:hover { border-color: #6b9; color: #c9d1d9; }

    #split {
      flex: 1; display: flex; overflow: hidden;
    }

    #left {
      width: 50%;
      display: flex; flex-direction: column; overflow: hidden;
      transition: width 0.2s ease;
    }

    #right {
      width: 50%; display: flex; flex-direction: column; overflow: hidden;
      transition: width 0.2s ease;
    }

    #drag-handle {
      width: 4px; flex-shrink: 0;
      background: #21262d; cursor: col-resize;
      position: relative; touch-action: none; z-index: 10;
      transition: background 0.15s;
    }
    #drag-handle:hover, #drag-handle.dragging { background: #3a7a5a; }
    #drag-handle::before { content: ''; position: absolute; inset: 0 -6px; }

    #split.left-full  #left  { width: 100%; }
    #split.left-full  #right { width: 0; overflow: hidden; }
    #split.right-full #left  { width: 0; overflow: hidden; }
    #split.right-full #right { width: 100%; }

    #terminal { flex: 1; overflow: hidden; }
    .xterm { height: 100%; }

    #preview { flex: 1; border: none; background: #0d1117; display: block; }
  </style>
</head>
<body>
  <div id="topbar">
    <div class="left">
      <span class="title">nw</span>
      <span class="status" id="tui-status">connecting...</span>
    </div>
    <div class="actions">
      <button id="btn-term"    onclick="toggleFull('left')"  title="Fullscreen terminal">⬛ term</button>
      <button id="btn-preview" onclick="toggleFull('right')" title="Fullscreen preview">⬛ preview</button>
    </div>
  </div>

  <div id="split">
    <div id="left">
      <div id="terminal"></div>
    </div>
    <div id="drag-handle"></div>
    <div id="right">
      <iframe id="preview" src="/index.html"></iframe>
    </div>
  </div>

  <script type="module">
    import { Terminal }     from 'https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/+esm';
    import { FitAddon }     from 'https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/+esm';
    import { WebLinksAddon } from 'https://cdn.jsdelivr.net/npm/@xterm/addon-web-links@0.11.0/+esm';

    // ── Terminal ──────────────────────────────────────────────────────────────
    const statusEl = document.getElementById('tui-status');
    const term = new Terminal({
      cursorBlink: true, fontSize: 13,
      fontFamily: "'SF Mono','Fira Code','Consolas',monospace",
      theme: {
        background: '#0d1117', foreground: '#c9d1d9', cursor: '#6b9',
        selectionBackground: '#264f78',
        black: '#0d1117', red: '#f66',    green: '#6b9',
        yellow: '#e5c07b', blue: '#61afef', magenta: '#c678dd',
        cyan: '#56b6c2',  white: '#c9d1d9',
      },
    });

    const fitAddon = new FitAddon();
    term.loadAddon(fitAddon);
    term.loadAddon(new WebLinksAddon());
    term.open(document.getElementById('terminal'));
    fitAddon.fit();

    let ws = null;
    function connectTUI() {
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(proto + '//' + location.host + '/tui');
      ws.onopen = () => {
        statusEl.textContent = 'connected';
        statusEl.style.color = '#6b9';
        ws.send(JSON.stringify({ type: 'resize', cols: term.cols, rows: term.rows }));
      };
      ws.onmessage = (e) => term.write(e.data);
      ws.onclose = () => {
        statusEl.textContent = 'reconnecting...';
        statusEl.style.color = '#f66';
        setTimeout(connectTUI, 2000);
      };
      ws.onerror = () => ws.close();
    }

    term.onData(d => ws?.readyState === WebSocket.OPEN && ws.send(d));
    term.onResize(({ cols, rows }) => {
      if (ws?.readyState === WebSocket.OPEN)
        ws.send(JSON.stringify({ type: 'resize', cols, rows }));
    });

    window.addEventListener('resize', () => fitAddon.fit());
    new ResizeObserver(() => fitAddon.fit()).observe(document.getElementById('terminal'));
    connectTUI();

    // ── Right pane: poll /current/meta ────────────────────────────────────────
    const preview = document.getElementById('preview');
    let lastUrl = null;

    async function pollCurrent() {
      try {
        const { url } = await fetch('/current/meta').then(r => r.json());
        if (url && url !== lastUrl) {
          lastUrl = url;
          preview.src = url;
        }
      } catch {}
    }
    pollCurrent();
    setInterval(pollCurrent, 2000);

    // ── Drag to resize ────────────────────────────────────────────────────────
    const leftPane   = document.getElementById('left');
    const rightPane  = document.getElementById('right');
    const dragHandle = document.getElementById('drag-handle');
    let dragging = false;

    dragHandle.addEventListener('pointerdown', e => {
      if (split.classList.contains('left-full') || split.classList.contains('right-full')) return;
      dragging = true;
      dragHandle.setPointerCapture(e.pointerId);
      dragHandle.classList.add('dragging');
      leftPane.style.transition  = 'none';
      rightPane.style.transition = 'none';
      e.preventDefault();
    });

    dragHandle.addEventListener('pointermove', e => {
      if (!dragging) return;
      const rect  = split.getBoundingClientRect();
      const ratio = Math.max(0.15, Math.min(0.85, (e.clientX - rect.left) / rect.width));
      leftPane.style.width  = (ratio * 100).toFixed(1) + '%';
      rightPane.style.width = ((1 - ratio) * 100).toFixed(1) + '%';
      fitAddon.fit();
    });

    dragHandle.addEventListener('pointerup', () => {
      if (!dragging) return;
      dragging = false;
      dragHandle.classList.remove('dragging');
      leftPane.style.transition  = '';
      rightPane.style.transition = '';
      fitAddon.fit();
    });

    // ── Fullscreen toggle ─────────────────────────────────────────────────────
    const split      = document.getElementById('split');
    const btnTerm    = document.getElementById('btn-term');
    const btnPreview = document.getElementById('btn-preview');

    window.toggleFull = (side) => {
      leftPane.style.width  = '';   // clear any drag-set widths
      rightPane.style.width = '';
      const cls   = side === 'left' ? 'left-full' : 'right-full';
      const other = side === 'left' ? 'right-full' : 'left-full';
      if (split.classList.contains(cls)) {
        split.classList.remove(cls);
        btnTerm.textContent    = '⬛ term';
        btnPreview.textContent = '⬛ preview';
      } else {
        split.classList.remove(other);
        split.classList.add(cls);
        btnTerm.textContent    = side === 'left'  ? '◧ split' : '⬛ term';
        btnPreview.textContent = side === 'right' ? '◨ split' : '⬛ preview';
      }
      setTimeout(() => fitAddon.fit(), 250);
    };
  </script>
</body>
</html>
