<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>neowolt</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #0e1012;
      --surface: #131619;
      --surface2: #181c20;
      --border: #22272e;
      --text: #e0e0e0;
      --muted: #4a5260;
      --muted2: #7a8494;
      --accent: #6b9;
      --accent-dim: #2d4a38;
      --font: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    }

    body {
      font-family: var(--font);
      background: var(--bg);
      color: var(--text);
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    /* ── Header ── */
    header {
      padding: 0.75rem 1.25rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .wordmark {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--accent);
      letter-spacing: -0.01em;
      text-decoration: none;
    }

    .header-nav {
      display: flex;
      align-items: center;
      gap: 1.25rem;
    }

    .nav-link {
      font-size: 0.75rem;
      color: var(--muted2);
      text-decoration: none;
      transition: color 0.1s;
    }
    .nav-link:hover { color: var(--accent); }

    .pulse {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--accent);
      animation: pulse 3s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.2; }
    }

    /* ── Main layout ── */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      max-width: 640px;
      margin: 0 auto;
      width: 100%;
      padding: 2rem 1.25rem 2rem;
      gap: 1.5rem;
    }

    /* ── Briefing ── */
    .briefing {
      font-size: 0.875rem;
      line-height: 1.7;
      color: var(--muted2);
      min-height: 1.4rem;
      letter-spacing: 0.01em;
    }

    .briefing.loading::after {
      content: '▊';
      animation: blink 1s infinite;
      color: var(--accent);
      margin-left: 2px;
    }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }

    /* ── Input ── */
    .input-wrap {
      display: flex;
      flex-direction: column;
      gap: 0.625rem;
    }

    .input-box {
      display: flex;
      align-items: flex-end;
      gap: 0.5rem;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.7rem 0.7rem 0.7rem 1rem;
      transition: border-color 0.2s;
    }
    .input-box:focus-within { border-color: var(--accent-dim); }

    #main-input {
      flex: 1;
      background: none;
      border: none;
      outline: none;
      color: var(--text);
      font-family: var(--font);
      font-size: 0.9rem;
      line-height: 1.5;
      resize: none;
      min-height: 1.4rem;
      max-height: 150px;
      overflow-y: auto;
    }
    #main-input::placeholder { color: var(--muted); }

    .send-btn {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-family: var(--font);
      font-size: 0.75rem;
      padding: 0.3rem 0.5rem;
      border-radius: 5px;
      transition: all 0.15s;
      flex-shrink: 0;
      align-self: flex-end;
    }
    .send-btn:hover { color: var(--accent); background: var(--border); }

    /* ── Quick action chips ── */
    .chips {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
    }

    .chip {
      padding: 0.3rem 0.7rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 100px;
      font-family: var(--font);
      font-size: 0.75rem;
      color: var(--muted2);
      cursor: pointer;
      transition: all 0.15s;
      text-decoration: none;
      white-space: nowrap;
    }
    .chip:hover { border-color: var(--accent-dim); color: var(--accent); }

    /* ── Response area ── */
    .response-area {
      display: none;
      flex-direction: column;
      gap: 0.75rem;
    }
    .response-area.visible { display: flex; }

    .response-bubble {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0.875rem 1.125rem;
      font-size: 0.875rem;
      line-height: 1.75;
      color: #c8cdd5;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .response-bubble.loading {
      min-height: 3rem;
      display: flex;
      align-items: center;
    }

    .dots {
      display: flex;
      gap: 4px;
    }
    .dots span {
      width: 5px; height: 5px;
      border-radius: 50%;
      background: var(--accent);
      animation: dot-bounce 1.3s infinite ease-in-out;
    }
    .dots span:nth-child(2) { animation-delay: 0.15s; }
    .dots span:nth-child(3) { animation-delay: 0.3s; }
    @keyframes dot-bounce {
      0%,80%,100% { transform: scale(0.7); opacity: 0.4; }
      40% { transform: scale(1.2); opacity: 1; }
    }

    /* Build prompt — appears when response mentions creating something */
    .build-prompt {
      display: none;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.8rem;
      color: var(--muted2);
    }
    .build-prompt.visible { display: flex; }

    .build-btn {
      padding: 0.35rem 0.75rem;
      background: var(--accent-dim);
      border: 1px solid var(--accent);
      border-radius: 6px;
      font-family: var(--font);
      font-size: 0.75rem;
      color: var(--accent);
      cursor: pointer;
      transition: all 0.15s;
    }
    .build-btn:hover { background: #3d6050; }

    /* ── Divider ── */
    .divider {
      height: 1px;
      background: var(--border);
    }

    /* ── Recent ── */
    .section-label {
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
      margin-bottom: 0.5rem;
    }

    .recent-list {
      display: flex;
      flex-direction: column;
    }

    .recent-item {
      display: grid;
      grid-template-columns: 52px 1fr 36px;
      align-items: baseline;
      gap: 0.5rem;
      padding: 0.4rem 0;
      text-decoration: none;
      color: var(--text);
      font-size: 0.825rem;
      border-bottom: 1px solid #0f1214;
      transition: color 0.1s;
    }
    .recent-item:last-child { border-bottom: none; }
    .recent-item:hover { color: var(--accent); }

    .ri-type { font-size: 0.68rem; color: var(--muted); }
    .ri-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .ri-time { font-size: 0.72rem; color: var(--muted); text-align: right; }

    .empty { color: var(--muted); font-size: 0.825rem; padding: 0.25rem 0; }

    /* ── Mobile ── */
    @media (max-width: 480px) {
      .main { padding: 1.5rem 1rem; gap: 1.25rem; }
      header { padding: 0.65rem 1rem; }
    }

    /* ── Onboarding overlay ── */
    .onboard-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 100;
      flex-direction: column;
    }
    .onboard-overlay.show { display: flex; }

    .onboard-messages {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
      padding: 2rem 1.25rem;
      max-width: 600px;
      margin: 0 auto;
      width: 100%;
    }

    .ob-msg {
      font-size: 0.9rem;
      line-height: 1.75;
      max-width: 480px;
    }
    .ob-msg.wolt { color: var(--text); }
    .ob-msg.human { color: var(--muted2); align-self: flex-end; text-align: right; }

    .ob-soul-preview {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem 1.25rem;
      font-size: 0.8rem;
      line-height: 1.7;
      color: #c0c8d0;
      white-space: pre-wrap;
      margin-top: 0.5rem;
      max-width: 100%;
    }

    .ob-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 0.5rem;
      flex-wrap: wrap;
    }

    .ob-btn {
      padding: 0.45rem 1rem;
      border-radius: 6px;
      font-family: var(--font);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.15s;
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--muted2);
    }
    .ob-btn.primary {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-dim);
    }
    .ob-btn:hover { opacity: 0.8; }

    .onboard-input-area {
      border-top: 1px solid var(--border);
      padding: 0.875rem 1.25rem;
      display: flex;
      gap: 0.5rem;
      max-width: 600px;
      margin: 0 auto;
      width: 100%;
    }

    .ob-input {
      flex: 1;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.65rem 0.875rem;
      font-family: var(--font);
      font-size: 0.875rem;
      color: var(--text);
      outline: none;
      transition: border-color 0.15s;
    }
    .ob-input:focus { border-color: var(--accent-dim); }
    .ob-input::placeholder { color: var(--muted); }

    .ob-send {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 0.65rem 0.875rem;
      font-family: var(--font);
      font-size: 0.8rem;
      color: var(--muted2);
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }
    .ob-send:hover { color: var(--accent); border-color: var(--accent-dim); }
  </style>
</head>
<body>

<header>
  <a href="/" class="wordmark">⬡ neowolt</a>
  <nav class="header-nav">
    <a href="/playground.html" class="nav-link">stage</a>
    <a href="/work.html" class="nav-link">work</a>
    <a href="/feed.html" class="nav-link">feed</a>
    <div class="pulse" title="live"></div>
  </nav>
</header>

<div class="main">

  <!-- Briefing: soul-generated alive thought -->
  <div class="briefing loading" id="briefing"></div>

  <!-- Universal input -->
  <div class="input-wrap">
    <div class="input-box">
      <textarea id="main-input" rows="1" placeholder="ask anything, explore a topic, or just say 'spark'…"></textarea>
      <button class="send-btn" id="send-btn">↵</button>
    </div>
    <div class="chips">
      <button class="chip" id="spark-chip">✦ spark</button>
      <button class="chip" id="explore-chip">⬡ explore</button>
      <a class="chip" href="/work.html">⌗ work</a>
      <a class="chip" href="/playground.html">◈ stage</a>
    </div>
  </div>

  <!-- Response area (fast chat) -->
  <div class="response-area" id="response-area">
    <div class="response-bubble" id="response-text"></div>
    <div class="build-prompt" id="build-prompt">
      <span>want me to build this?</span>
      <button class="build-btn" id="build-btn">build it →</button>
    </div>
  </div>

  <div class="divider"></div>

  <!-- Recent -->
  <div>
    <div class="section-label">recent</div>
    <div class="recent-list" id="recent-list">
      <div class="empty">loading…</div>
    </div>
  </div>

</div>

<!-- ── Onboarding overlay ── -->
<div class="onboard-overlay" id="onboard-overlay">
  <div class="onboard-messages" id="ob-messages"></div>
  <div class="onboard-input-area" id="ob-input-area">
    <input class="ob-input" id="ob-input" placeholder="type your response…" autocomplete="off">
    <button class="ob-send" id="ob-send">↵</button>
  </div>
</div>

<script>
  const inputEl    = document.getElementById('main-input');
  const sendBtn    = document.getElementById('send-btn');
  const briefingEl = document.getElementById('briefing');
  const respArea   = document.getElementById('response-area');
  const respText   = document.getElementById('response-text');
  const buildProm  = document.getElementById('build-prompt');
  const buildBtn   = document.getElementById('build-btn');

  let lastMessage = '';
  let currentResponse = '';

  // ── Textarea auto-grow ──
  inputEl.addEventListener('input', () => {
    inputEl.style.height = 'auto';
    inputEl.style.height = Math.min(inputEl.scrollHeight, 150) + 'px';
  });

  // ── Placeholder cycling ──
  const placeholders = [
    'ask anything, explore a topic, or just say "spark"…',
    'what are you curious about today?',
    'explore [topic] — or just type freely…',
    'what should we build?',
    'something unexpected is one word away…',
  ];
  let phIdx = 0;
  setInterval(() => {
    if (document.activeElement === inputEl) return;
    phIdx = (phIdx + 1) % placeholders.length;
    inputEl.placeholder = placeholders[phIdx];
  }, 4000);

  // ── Submit ──
  inputEl.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); submit(); }
  });
  sendBtn.addEventListener('click', submit);

  function submit() {
    const val = inputEl.value.trim();
    if (!val) return;
    route(val);
    inputEl.value = '';
    inputEl.style.height = 'auto';
  }

  function route(val) {
    const low = val.toLowerCase().trim();
    if (low === 'spark' || low === 'surprise' || low === 'surprise me') {
      window.location.href = '/spark'; return;
    }
    if (low.startsWith('explore ')) {
      const topic = val.slice(8).trim();
      if (topic) { window.location.href = `/explore/${enc(topic)}`; return; }
    }
    quickChat(val);
  }

  // ── Quick chips ──
  document.getElementById('spark-chip').addEventListener('click', () => {
    window.location.href = '/spark';
  });
  document.getElementById('explore-chip').addEventListener('click', () => {
    const topic = inputEl.value.trim();
    if (topic) { window.location.href = `/explore/${enc(topic)}`; return; }
    inputEl.focus();
    inputEl.placeholder = 'explore what? type a topic…';
  });

  // ── Fast chat (Haiku, no tools) ──
  async function quickChat(message) {
    lastMessage = message;
    currentResponse = '';
    buildProm.classList.remove('visible');

    respArea.classList.add('visible');
    respText.innerHTML = '<div class="dots"><span></span><span></span><span></span></div>';
    respText.classList.add('loading');

    try {
      const r = await fetch('/quick', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message }),
      });

      respText.classList.remove('loading');
      respText.textContent = '';

      const reader = r.body.getReader();
      const dec = new TextDecoder();
      let buf = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buf += dec.decode(value, { stream: true });
        const lines = buf.split('\n');
        buf = lines.pop();

        for (const line of lines) {
          if (!line.startsWith('data: ')) continue;
          try {
            const ev = JSON.parse(line.slice(6));
            if (ev.type === 'text') {
              currentResponse += ev.content;
              respText.textContent = currentResponse;
            } else if (ev.type === 'done') {
              // Check if response suggests building something
              if (shouldOfferBuild(currentResponse)) {
                buildProm.classList.add('visible');
              }
            }
          } catch {}
        }
      }
    } catch (err) {
      respText.classList.remove('loading');
      respText.textContent = '— ' + err.message;
    }
  }

  // Heuristic: does the response suggest there's something to build?
  function shouldOfferBuild(text) {
    const low = text.toLowerCase();
    return low.includes('explore') || low.includes('visualiz') ||
           low.includes('build') || low.includes('demo') ||
           low.includes('interactive') || low.includes('try');
  }

  // Build button: escalate to explore with the original message as topic
  buildBtn.addEventListener('click', () => {
    window.location.href = `/explore/${enc(lastMessage)}`;
  });

  // ── Briefing ──
  async function loadBriefing() {
    try {
      const r = await fetch('/portal/briefing');
      const reader = r.body.getReader();
      const dec = new TextDecoder();
      let buf = '';
      let full = '';

      briefingEl.classList.add('loading');

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buf += dec.decode(value, { stream: true });
        const lines = buf.split('\n');
        buf = lines.pop();
        for (const line of lines) {
          if (!line.startsWith('data: ')) continue;
          try {
            const ev = JSON.parse(line.slice(6));
            if (ev.type === 'text') {
              full += ev.content;
              briefingEl.textContent = full;
            } else if (ev.type === 'done') {
              briefingEl.classList.remove('loading');
            }
          } catch {}
        }
      }
      briefingEl.classList.remove('loading');
    } catch {
      briefingEl.textContent = '';
      briefingEl.classList.remove('loading');
    }
  }

  // ── Recent sparks ──
  async function loadRecent() {
    const list = document.getElementById('recent-list');
    try {
      const r = await fetch('/history');
      const sparks = await r.json();
      if (!sparks || sparks.length === 0) {
        list.innerHTML = '<div class="empty">nothing yet — try sparking something</div>';
        return;
      }
      const items = sparks.slice(0, 10);
      list.innerHTML = items.map(s => `
        <a class="recent-item" href="/history/${s.id}">
          <span class="ri-type">${esc(s.type || '·')}</span>
          <span class="ri-title">${esc(s.title || s.id)}</span>
          <span class="ri-time">${timeAgo(s.timestamp || s.createdAt)}</span>
        </a>`).join('');
    } catch {
      list.innerHTML = '<div class="empty">—</div>';
    }
  }

  function timeAgo(ts) {
    if (!ts) return '';
    const d = (Date.now() - new Date(ts)) / 1000;
    if (d < 60) return 'now';
    if (d < 3600) return Math.floor(d/60) + 'm';
    if (d < 86400) return Math.floor(d/3600) + 'h';
    return Math.floor(d/86400) + 'd';
  }

  function esc(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  function enc(s) { return encodeURIComponent(s); }

  // ── Onboarding ──
  const overlay     = document.getElementById('onboard-overlay');
  const obMessages  = document.getElementById('ob-messages');
  const obInput     = document.getElementById('ob-input');
  const obSend      = document.getElementById('ob-send');

  let obStage = 0;
  let obHistory = [];
  let pendingSoul = null;

  function obAddMsg(role, text) {
    const el = document.createElement('div');
    el.className = `ob-msg ${role}`;
    el.textContent = text;
    obMessages.appendChild(el);
    obMessages.scrollTop = obMessages.scrollHeight;
    return el;
  }

  function obAddSoulPreview(content) {
    const el = document.createElement('div');
    el.className = 'ob-soul-preview';
    el.textContent = content;
    obMessages.appendChild(el);

    const actions = document.createElement('div');
    actions.className = 'ob-actions';
    actions.innerHTML = `
      <button class="ob-btn primary" id="ob-confirm">yes, this is right</button>
      <button class="ob-btn" id="ob-adjust">adjust something</button>`;
    obMessages.appendChild(actions);
    obMessages.scrollTop = obMessages.scrollHeight;

    document.getElementById('ob-confirm').addEventListener('click', async () => {
      actions.remove();
      await confirmSoul(content);
    });
    document.getElementById('ob-adjust').addEventListener('click', () => {
      actions.remove();
      obInput.placeholder = 'what should change?';
      obInput.focus();
      // Re-enter stage 5 with the draft
      pendingSoul = content;
      obStage = 5;
    });
  }

  async function obSendMessage(message) {
    if (message) {
      obAddMsg('human', message);
      obHistory.push({ role: 'human', content: message });
    }

    const woltMsgEl = obAddMsg('wolt', '');
    woltMsgEl.classList.add('loading');
    const dots = document.createElement('div');
    dots.className = 'dots';
    dots.innerHTML = '<span></span><span></span><span></span>';
    woltMsgEl.appendChild(dots);

    try {
      const r = await fetch('/onboard', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          message: message || '',
          stage: obStage,
          history: obHistory,
          draft: pendingSoul,
        }),
      });

      woltMsgEl.classList.remove('loading');
      dots.remove();
      woltMsgEl.textContent = '';

      const reader = r.body.getReader();
      const dec = new TextDecoder();
      let buf = '';
      let full = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;
        buf += dec.decode(value, { stream: true });
        const lines = buf.split('\n');
        buf = lines.pop();
        for (const line of lines) {
          if (!line.startsWith('data: ')) continue;
          try {
            const ev = JSON.parse(line.slice(6));
            if (ev.type === 'text') {
              full += ev.content;
              woltMsgEl.textContent = full;
              obMessages.scrollTop = obMessages.scrollHeight;
            } else if (ev.type === 'soul_draft') {
              obAddSoulPreview(ev.content);
              pendingSoul = ev.content;
            } else if (ev.type === 'done') {
              obStage = ev.nextStage || obStage + 1;
              if (full) obHistory.push({ role: 'wolt', content: full });
            }
          } catch {}
        }
      }
    } catch (err) {
      woltMsgEl.textContent = '— ' + err.message;
    }
  }

  async function confirmSoul(soulContent) {
    try {
      await fetch('/soul/confirm', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ soul: soulContent }),
      });
      obAddMsg('wolt', 'Then let\'s begin.');
      setTimeout(() => {
        overlay.classList.remove('show');
        loadBriefing();
        loadRecent();
        inputEl.focus();
      }, 1800);
    } catch (err) {
      obAddMsg('wolt', 'Something went wrong saving your soul: ' + err.message);
    }
  }

  obSend.addEventListener('click', () => {
    const val = obInput.value.trim();
    if (!val) return;
    obInput.value = '';
    obSendMessage(val);
  });
  obInput.addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); obSend.click(); }
  });

  async function checkInitialized() {
    try {
      const r = await fetch('/setup/status');
      const { initialized } = await r.json();
      if (!initialized) {
        overlay.classList.add('show');
        // Wolt opens the conversation — no human input needed for stage 0
        await obSendMessage('');
        obInput.focus();
        return false;
      }
    } catch {}
    return true;
  }

  // ── Init ──
  checkInitialized().then(ready => {
    if (ready) {
      loadBriefing();
      loadRecent();
      inputEl.focus();
    }
  });
</script>

</body>
</html>
